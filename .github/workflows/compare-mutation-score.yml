name: Mutation Score
on:
  issue_comment:
    types:
      - created

jobs:
  verify-comment:
    permissions:
      pull-requests: write
    runs-on: ubuntu-22.04
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/mutants') }}
    steps:
      - name: ðŸ’¬ Comment Acknowledgement
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '[Running Mutation Tests](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
              })
            
  mutants-master:
    name: Run Mutation Tests on master
    needs: [verify-comment]
    uses: ./.github/workflows/run-mutation-tests.yml
    with:
      code-ref: 'master'

  mutants-branch:
    name: Run Mutation Tests on branch
    needs: [verify-comment]
    uses: ./.github/workflows/run-mutation-tests.yml
    with:
      code-ref: ${{ github.head_ref }}

  comment-comparison:
    name: ðŸ’¬ Comment Comparison
    runs-on: ubuntu-22.04
    needs: [mutants-master, mutants-branch]
    permissions:
      pull-requests: write
    steps:
      - name: ðŸ›’ Checkout
        uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          github-token: '${{ github.token }}'
          script: |
            const mutantsOutput = {
              master_caught: ${{ needs.mutants-master.outputs.caught }},
              master_missed: ${{ needs.mutants-master.outputs.missed }},
              feature_caught: ${{ needs.mutants-branch.outputs.caught }},
              feature_missed: ${{ needs.mutants-branch.outputs.missed }}
            };
            const commentComparison = require('./.github/scripts/commentMutationComparison.js');
            commentComparison({github, context, mutantsOutput});

